<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据库连接测试</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h2>数据库连接测试页面</h2>
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>源数据库测试</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary" id="testSource">测试源数据库</button>
                        <div id="sourceResult" class="mt-3"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>目标数据库测试</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-success" id="testTarget">测试目标数据库</button>
                        <div id="targetResult" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>调试信息</h5>
                    </div>
                    <div class="card-body">
                        <div id="debugInfo" style="height: 300px; overflow-y: auto; background: #f8f9fa; padding: 10px; font-family: monospace;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        function log(message) {
            const debugDiv = document.getElementById('debugInfo');
            const timestamp = new Date().toLocaleTimeString();
            debugDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            debugDiv.scrollTop = debugDiv.scrollHeight;
            console.log(message);
        }

        async function testDatabase(dbType) {
            const resultDiv = document.getElementById(dbType + 'Result');
            const button = document.getElementById('test' + dbType.charAt(0).toUpperCase() + dbType.slice(1));
            
            button.disabled = true;
            button.textContent = '测试中...';
            resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm"></div> 测试中...';
            
            log(`开始测试${dbType}数据库`);
            
            try {
                const startTime = Date.now();
                const response = await axios.post('/get_tables', {
                    db_type: dbType
                });
                const endTime = Date.now();
                
                log(`${dbType}数据库测试完成，耗时: ${endTime - startTime}ms`);
                
                if (response.data.success) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <strong>连接成功!</strong><br>
                            表数量: ${response.data.tables.length}<br>
                            耗时: ${endTime - startTime}ms
                        </div>
                    `;
                    log(`${dbType}数据库连接成功，获取到${response.data.tables.length}个表`);
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <strong>连接失败!</strong><br>
                            ${response.data.message}
                        </div>
                    `;
                    log(`${dbType}数据库连接失败: ${response.data.message}`);
                }
            } catch (error) {
                const endTime = Date.now();
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>请求失败!</strong><br>
                        ${error.message}
                    </div>
                `;
                log(`${dbType}数据库请求失败: ${error.message}`);
            }
            
            button.disabled = false;
            button.textContent = `测试${dbType === 'source' ? '源' : '目标'}数据库`;
        }

        document.getElementById('testSource').addEventListener('click', () => testDatabase('source'));
        document.getElementById('testTarget').addEventListener('click', () => testDatabase('target'));
        
        log('测试页面已加载');
    </script>
</body>
</html>

