<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MySQL 数据库互导程序 - 简化版</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .status-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
        }
        .status-success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .status-error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .status-info {
            background: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }
        .step-box {
            border: 2px solid #007bff;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            background: white;
        }
        .step-title {
            color: #007bff;
            font-weight: bold;
            margin-bottom: 15px;
        }
        .btn-large {
            padding: 12px 24px;
            font-size: 16px;
            margin: 5px;
        }
        .log-area {
            background: #000;
            color: #0f0;
            font-family: 'Courier New', monospace;
            padding: 15px;
            border-radius: 5px;
            height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
            <div class="container-fluid">
                <a class="navbar-brand" href="/">
                    <i class="fas fa-database"></i> MySQL 数据库互导程序 - 简化版
                </a>
                <div class="navbar-nav ms-auto">
                    <a class="nav-link" href="/config">
                        <i class="fas fa-cog"></i> 配置管理
                    </a>
                    <a class="nav-link" href="/history">
                        <i class="fas fa-history"></i> 导入历史
                    </a>
                </div>
            </div>
        </nav>

        <!-- 状态显示区域 -->
        <div class="row">
            <div class="col-12">
                <div id="statusBox" class="status-box status-info">
                    <h5><i class="fas fa-info-circle"></i> 系统状态</h5>
                    <div id="statusText">正在初始化系统...</div>
                </div>
            </div>
        </div>

        <!-- 步骤1: 数据库表选择 -->
        <div class="step-box">
            <div class="step-title">
                <i class="fas fa-list"></i> 步骤1: 选择数据库表
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <h6>源数据库表 (www_office369)</h6>
                    <div class="mb-2">
                        <button class="btn btn-outline-primary btn-sm" onclick="loadSourceTables()">
                            <i class="fas fa-refresh"></i> 刷新源表
                        </button>
                        <span id="sourceStatus" class="ms-2 text-muted"></span>
                    </div>
                    <select class="form-select" id="sourceTable" onchange="onTableChange()">
                        <option value="">请选择源表...</option>
                    </select>
                </div>
                
                <div class="col-md-6">
                    <h6>目标数据库表 (office369_com)</h6>
                    <div class="mb-2">
                        <button class="btn btn-outline-success btn-sm" onclick="loadTargetTables()">
                            <i class="fas fa-refresh"></i> 刷新目标表
                        </button>
                        <span id="targetStatus" class="ms-2 text-muted"></span>
                    </div>
                    <select class="form-select" id="targetTable" onchange="onTableChange()">
                        <option value="">请选择目标表...</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- 步骤2: 字段映射 -->
        <div class="step-box">
            <div class="step-title">
                <i class="fas fa-link"></i> 步骤2: 字段映射配置
            </div>
            
            <div class="mb-3">
                <button class="btn btn-primary btn-large" id="loadFieldsBtn" onclick="loadFields()" disabled>
                    <i class="fas fa-link"></i> 加载字段映射
                </button>
                <button class="btn btn-info btn-large" id="previewBtn" onclick="previewData()" disabled>
                    <i class="fas fa-eye"></i> 预览数据
                </button>
            </div>
            
            <div id="fieldMappingArea" style="display: none;">
                <h6>字段映射配置</h6>
                <div class="mb-3">
                    <button type="button" class="btn btn-sm btn-success" onclick="applyAutoMatch()">
                        <i class="fas fa-magic"></i> 应用智能匹配
                    </button>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="clearAllMappings()">
                        <i class="fas fa-eraser"></i> 清空所有映射
                    </button>
                </div>
                <div class="table-responsive">
                    <table class="table table-bordered" id="fieldMappingTable">
                        <thead class="table-light">
                            <tr>
                                <th>目标字段</th>
                                <th>源字段</th>
                                <th>默认值</th>
                            </tr>
                        </thead>
                        <tbody id="fieldMappingBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 步骤3: 导入设置 -->
        <div class="step-box">
            <div class="step-title">
                <i class="fas fa-cogs"></i> 步骤3: 导入设置
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <label class="form-label">导入模式</label>
                    <select class="form-select" id="importMode">
                        <option value="overwrite">覆盖模式 (REPLACE INTO)</option>
                        <option value="insert">仅新增模式 (INSERT IGNORE)</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">每页记录数</label>
                    <input type="number" class="form-control" id="pageSize" value="100" min="1" max="1000">
                </div>
            </div>
            
            <div class="mt-3">
                <button class="btn btn-warning btn-large" onclick="backupData()">
                    <i class="fas fa-save"></i> 备份目标表数据
                </button>
                <button class="btn btn-success btn-large" id="startImportBtn" onclick="startImport()" disabled>
                    <i class="fas fa-play"></i> 开始导入
                </button>
            </div>
        </div>

        <!-- 步骤4: 导入进度 -->
        <div class="step-box" id="progressBox" style="display: none;">
            <div class="step-title">
                <i class="fas fa-tasks"></i> 步骤4: 导入进度
            </div>
            
            <div class="progress mb-3">
                <div class="progress-bar" id="progressBar" role="progressbar" style="width: 0%">
                    <span id="progressText">0%</span>
                </div>
            </div>
            
            <div class="log-area" id="logArea">
                等待开始导入...
            </div>
            
            <div class="mt-3">
                <button class="btn btn-secondary" onclick="stopImport()">
                    <i class="fas fa-stop"></i> 停止导入
                </button>
                <button class="btn btn-info" onclick="refreshLog()">
                    <i class="fas fa-refresh"></i> 手动刷新
                </button>
                <button class="btn btn-success" id="autoRefreshBtn" onclick="toggleAutoRefresh()">
                    <i class="fas fa-pause"></i> 自动刷新: 开启
                </button>
            </div>
        </div>
    </div>

    <!-- 版权信息 -->
    <footer class="mt-5 py-4 bg-light text-center">
        <div class="container">
            <p class="mb-0 text-muted">
                技术支持 <a href="http://www.wangyiyi.net" target="_blank" class="text-decoration-none">一码工坊</a> 版权所有
            </p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        // 全局变量
        let sourceFields = [];
        let targetFields = [];
        let fieldMapping = {};
        let defaultValues = {};
        let autoMatchedFields = {};
        // 自动刷新开关
        let autoRefreshEnabled = true;
        let logInterval = null;
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('页面加载完成，初始化自动刷新状态');
            // 确保自动刷新按钮状态正确
            const btn = document.getElementById('autoRefreshBtn');
            if (autoRefreshEnabled) {
                btn.innerHTML = '<i class="fas fa-pause"></i> 自动刷新: 开启';
                btn.className = 'btn btn-success';
            } else {
                btn.innerHTML = '<i class="fas fa-play"></i> 自动刷新: 关闭';
                btn.className = 'btn btn-warning';
            }
        });

        // 状态管理
        function updateStatus(message, type = 'info') {
            const statusBox = document.getElementById('statusBox');
            const statusText = document.getElementById('statusText');
            
            statusBox.className = `status-box status-${type}`;
            statusText.innerHTML = message;
            
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // 加载源数据库表
        async function loadSourceTables() {
            updateStatus('正在加载源数据库表...', 'info');
            document.getElementById('sourceStatus').textContent = '加载中...';
            
            try {
                const response = await axios.post('/get_tables', { db_type: 'source' });
                
                if (response.data.success) {
                    const select = document.getElementById('sourceTable');
                    select.innerHTML = '<option value="">请选择源表...</option>';
                    
                    response.data.tables.forEach(table => {
                        const option = document.createElement('option');
                        option.value = table;
                        option.textContent = table;
                        select.appendChild(option);
                    });
                    
                    document.getElementById('sourceStatus').textContent = `已加载 ${response.data.tables.length} 个表`;
                    updateStatus('源数据库表加载成功', 'success');
                } else {
                    document.getElementById('sourceStatus').textContent = '加载失败';
                    updateStatus('源数据库表加载失败: ' + response.data.message, 'error');
                }
            } catch (error) {
                document.getElementById('sourceStatus').textContent = '加载失败';
                updateStatus('源数据库表加载失败: ' + error.message, 'error');
            }
        }

        // 加载目标数据库表
        async function loadTargetTables() {
            updateStatus('正在加载目标数据库表...', 'info');
            document.getElementById('targetStatus').textContent = '加载中...';
            
            try {
                const response = await axios.post('/get_tables', { db_type: 'target' });
                
                if (response.data.success) {
                    const select = document.getElementById('targetTable');
                    select.innerHTML = '<option value="">请选择目标表...</option>';
                    
                    response.data.tables.forEach(table => {
                        const option = document.createElement('option');
                        option.value = table;
                        option.textContent = table;
                        select.appendChild(option);
                    });
                    
                    document.getElementById('targetStatus').textContent = `已加载 ${response.data.tables.length} 个表`;
                    updateStatus('目标数据库表加载成功', 'success');
                } else {
                    document.getElementById('targetStatus').textContent = '加载失败';
                    updateStatus('目标数据库表加载失败: ' + response.data.message, 'error');
                }
            } catch (error) {
                document.getElementById('targetStatus').textContent = '加载失败';
                updateStatus('目标数据库表加载失败: ' + error.message, 'error');
            }
        }

        // 表选择变化
        function onTableChange() {
            const sourceTable = document.getElementById('sourceTable').value;
            const targetTable = document.getElementById('targetTable').value;
            
            console.log('表选择变化:', { sourceTable, targetTable });
            
            // 清空字段映射缓存
            fieldMapping = {};
            defaultValues = {};
            autoMatchedFields = {};
            
            // 隐藏字段映射区域
            document.getElementById('fieldMappingArea').style.display = 'none';
            
            console.log('字段映射缓存已清空');
            
            const loadFieldsBtn = document.getElementById('loadFieldsBtn');
            const previewBtn = document.getElementById('previewBtn');
            const startImportBtn = document.getElementById('startImportBtn');
            
            // 检查按钮是否存在
            if (!loadFieldsBtn || !previewBtn || !startImportBtn) {
                console.error('按钮元素未找到');
                return;
            }
            
            // 更新按钮状态
            const canLoadFields = sourceTable && targetTable && sourceTable !== '' && targetTable !== '';
            const canPreview = sourceTable && sourceTable !== '';
            const canStartImport = canLoadFields;
            
            loadFieldsBtn.disabled = !canLoadFields;
            previewBtn.disabled = !canPreview;
            startImportBtn.disabled = !canStartImport;
            
            console.log('按钮状态:', {
                loadFields: canLoadFields ? '启用' : '禁用',
                preview: canPreview ? '启用' : '禁用',
                startImport: canStartImport ? '启用' : '禁用'
            });
            
            if (sourceTable && targetTable) {
                updateStatus(`已选择: ${sourceTable} → ${targetTable}`, 'success');
            } else {
                updateStatus('请选择源表和目标表', 'info');
            }
        }

        // 加载字段映射
        async function loadFields() {
            const sourceTable = document.getElementById('sourceTable').value;
            const targetTable = document.getElementById('targetTable').value;
            
            console.log('选择的表:', { sourceTable, targetTable });
            
            if (!sourceTable || !targetTable) {
                updateStatus('请先选择源表和目标表', 'error');
                return;
            }
            
            if (sourceTable === '' || targetTable === '') {
                updateStatus('请选择有效的表名', 'error');
                return;
            }
            
            // 防止重复点击
            const loadFieldsBtn = document.getElementById('loadFieldsBtn');
            if (loadFieldsBtn.disabled) {
                console.log('按钮已禁用，忽略重复点击');
                return;
            }
            
            // 禁用按钮防止重复点击
            loadFieldsBtn.disabled = true;
            loadFieldsBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 加载中...';
            
            updateStatus('正在加载字段信息...', 'info');
            
            try {
                const requestData = {
                    source_table: sourceTable,
                    target_table: targetTable
                };
                
                console.log('发送请求数据:', requestData);
                
                const response = await axios.post('/get_fields', requestData);
                
                console.log('字段映射响应:', response.data);
                
            if (response.data.success) {
                sourceFields = response.data.source_fields || [];
                targetFields = response.data.target_fields || [];
                autoMatchedFields = response.data.auto_matched_fields || {};

                console.log('源字段:', sourceFields);
                console.log('目标字段:', targetFields);
                console.log('自动匹配结果:', autoMatchedFields);

                if (sourceFields.length === 0 || targetFields.length === 0) {
                    updateStatus('字段信息为空，请检查表是否存在', 'error');
                    return;
                }

                renderFieldMapping();
                document.getElementById('fieldMappingArea').style.display = 'block';
                
                const autoMatchCount = Object.keys(autoMatchedFields).length;
                updateStatus(`字段映射加载成功 - 源字段: ${sourceFields.length}个, 目标字段: ${targetFields.length}个, 自动匹配: ${autoMatchCount}个`, 'success');
            } else {
                updateStatus('字段映射加载失败: ' + response.data.message, 'error');
            }
            } catch (error) {
                console.error('字段映射加载错误:', error);
                updateStatus('字段映射加载失败: ' + error.message, 'error');
            } finally {
                // 恢复按钮状态
                loadFieldsBtn.disabled = false;
                loadFieldsBtn.innerHTML = '<i class="fas fa-link"></i> 加载字段映射';
            }
        }

        // 应用智能匹配
        function applyAutoMatch() {
            if (!autoMatchedFields || Object.keys(autoMatchedFields).length === 0) {
                updateStatus('没有可用的自动匹配结果', 'warning');
                return;
            }
            
            let appliedCount = 0;
            targetFields.forEach(field => {
                const sourceSelect = document.getElementById(`source_${field}`);
                if (sourceSelect && autoMatchedFields[field]) {
                    sourceSelect.value = autoMatchedFields[field];
                    fieldMapping[field] = autoMatchedFields[field];
                    appliedCount++;
                }
            });
            
            updateStatus(`已应用 ${appliedCount} 个智能匹配`, 'success');
        }

        // 清空所有映射
        function clearAllMappings() {
            targetFields.forEach(field => {
                const sourceSelect = document.getElementById(`source_${field}`);
                if (sourceSelect) {
                    sourceSelect.value = '';
                    fieldMapping[field] = '';
                }
            });
            
            updateStatus('已清空所有字段映射', 'info');
        }

        // 渲染字段映射
        function renderFieldMapping() {
            const tbody = document.getElementById('fieldMappingBody');
            tbody.innerHTML = '';
            
            console.log('开始渲染字段映射:', { sourceFields, targetFields });
            
            if (!targetFields || targetFields.length === 0) {
                console.error('目标字段为空');
                return;
            }
            
            targetFields.forEach(field => {
                const tr = document.createElement('tr');
                
                // 目标字段
                const targetCell = document.createElement('td');
                targetCell.textContent = field;
                
                // 源字段选择
                const sourceCell = document.createElement('td');
                const sourceSelect = document.createElement('select');
                sourceSelect.className = 'form-select form-select-sm';
                sourceSelect.innerHTML = '<option value="">不映射</option>';
                
                if (sourceFields && sourceFields.length > 0) {
                    sourceFields.forEach(sourceField => {
                        const option = document.createElement('option');
                        option.value = sourceField;
                        option.textContent = sourceField;
                        
                        // 如果是自动匹配的字段，设置为选中
                        if (autoMatchedFields[field] === sourceField) {
                            option.selected = true;
                            fieldMapping[field] = sourceField;
                        }
                        
                        sourceSelect.appendChild(option);
                    });
                }
                
                sourceSelect.addEventListener('change', () => {
                    fieldMapping[field] = sourceSelect.value;
                });
                
                sourceCell.appendChild(sourceSelect);
                
                // 默认值
                const defaultCell = document.createElement('td');
                const defaultInput = document.createElement('input');
                defaultInput.type = 'text';
                defaultInput.className = 'form-control form-control-sm';
                defaultInput.placeholder = '默认值';
                
                defaultInput.addEventListener('input', () => {
                    defaultValues[field] = defaultInput.value;
                });
                
                defaultCell.appendChild(defaultInput);
                
                tr.appendChild(targetCell);
                tr.appendChild(sourceCell);
                tr.appendChild(defaultCell);
                tbody.appendChild(tr);
            });
            
            console.log('字段映射渲染完成');
        }

        // 预览数据
        async function previewData() {
            const sourceTable = document.getElementById('sourceTable').value;
            
            if (!sourceTable) {
                updateStatus('请先选择源表', 'error');
                return;
            }
            
            updateStatus('正在预览数据...', 'info');
            
            try {
                const response = await axios.post('/preview_data', {
                    source_table: sourceTable,
                    limit: 5
                });
                
                if (response.data.success) {
                    const data = response.data.data;
                    let previewHtml = '<h6>数据预览 (前5条):</h6><div class="table-responsive"><table class="table table-sm table-bordered"><thead><tr>';
                    
                    if (data.length > 0) {
                        Object.keys(data[0]).forEach(key => {
                            previewHtml += `<th>${key}</th>`;
                        });
                        previewHtml += '</tr></thead><tbody>';
                        
                        data.forEach(row => {
                            previewHtml += '<tr>';
                            Object.values(row).forEach(value => {
                                previewHtml += `<td>${value || ''}</td>`;
                            });
                            previewHtml += '</tr>';
                        });
                        previewHtml += '</tbody></table></div>';
                    } else {
                        previewHtml += '<p class="text-muted">表中没有数据</p>';
                    }
                    
                    updateStatus(previewHtml, 'success');
                } else {
                    updateStatus('数据预览失败: ' + response.data.message, 'error');
                }
            } catch (error) {
                updateStatus('数据预览失败: ' + error.message, 'error');
            }
        }

        // 备份数据
        async function backupData() {
            const targetTable = document.getElementById('targetTable').value;
            
            if (!targetTable) {
                updateStatus('请先选择目标表', 'error');
                return;
            }
            
            updateStatus('正在备份数据...', 'info');
            
            try {
                const response = await axios.post('/backup_data', {
                    target_table: targetTable
                });
                
                if (response.data.success) {
                    updateStatus('数据备份成功: ' + response.data.message, 'success');
                } else {
                    updateStatus('数据备份失败: ' + response.data.message, 'error');
                }
            } catch (error) {
                updateStatus('数据备份失败: ' + error.message, 'error');
            }
        }

        // 开始导入
        async function startImport() {
            const sourceTable = document.getElementById('sourceTable').value;
            const targetTable = document.getElementById('targetTable').value;
            const importMode = document.getElementById('importMode').value;
            const pageSize = parseInt(document.getElementById('pageSize').value);
            
            console.log('开始导入...');
            console.log('源表:', sourceTable);
            console.log('目标表:', targetTable);
            console.log('字段映射:', fieldMapping);
            console.log('默认值:', defaultValues);
            console.log('导入模式:', importMode);
            console.log('页面大小:', pageSize);
            
            if (!sourceTable || !targetTable) {
                updateStatus('请先选择源表和目标表', 'error');
                return;
            }
            
            updateStatus('正在启动导入任务...', 'info');
            document.getElementById('progressBox').style.display = 'block';
            
            try {
                const response = await axios.post('/start_import', {
                    source_table: sourceTable,
                    target_table: targetTable,
                    field_mapping: fieldMapping,
                    default_values: defaultValues,
                    import_mode: importMode,
                    page_size: pageSize
                });
                
                if (response.data.success) {
                    updateStatus('导入任务已启动', 'success');
                    startLogPolling();
                } else {
                    updateStatus('导入任务启动失败: ' + response.data.message, 'error');
                }
            } catch (error) {
                updateStatus('导入任务启动失败: ' + error.message, 'error');
            }
        }

        // 开始日志轮询
        function startLogPolling() {
            console.log('开始日志轮询...');
            console.log('autoRefreshEnabled:', autoRefreshEnabled);
            
            if (logInterval) {
                clearInterval(logInterval);
                console.log('清除旧的轮询间隔');
            }
            
            // 只有在自动刷新开启时才启动轮询
            if (!autoRefreshEnabled) {
                console.log('自动刷新已关闭，跳过日志轮询');
                return;
            }
            
            console.log('启动新的轮询间隔，间隔500ms');
            logInterval = setInterval(async () => {
                try {
                    console.log('轮询日志...');
                    const response = await axios.get('/get_log');
                    console.log('日志API响应:', response.data);
                    
                    const logArea = document.getElementById('logArea');
                    if (logArea) {
                        // 更新日志内容
                        logArea.textContent = response.data.log;
                        logArea.scrollTop = logArea.scrollHeight;
                        
                        // 更新状态信息
                        const statusDiv = document.getElementById('statusMessage');
                        if (statusDiv && response.data.log) {
                            const lines = response.data.log.split('\n');
                            const lastLine = lines[lines.length - 2] || lines[lines.length - 1]; // 获取最后一行
                            
                            if (lastLine.includes('正在导入第') && lastLine.includes('页')) {
                                statusDiv.className = 'alert alert-info mt-3';
                                statusDiv.textContent = lastLine.trim();
                            } else if (lastLine.includes('导入完成')) {
                                statusDiv.className = 'alert alert-success mt-3';
                                statusDiv.textContent = '导入完成！';
                            } else if (lastLine.includes('导入失败') || lastLine.includes('错误')) {
                                statusDiv.className = 'alert alert-danger mt-3';
                                statusDiv.textContent = lastLine.trim();
                            }
                        }
                    }
                    
                    // 检查是否完成 - 更精确的检查
                    const logText = response.data.log;
                    if (logText.includes('导入完成！') || logText.includes('导入失败') || logText.includes('导入过程中发生错误')) {
                        console.log('导入完成，停止日志轮询');
                        clearInterval(logInterval);
                        logInterval = null;
                    } else {
                        console.log('轮询继续，当前日志长度:', logText.length);
                    }
                } catch (error) {
                    console.error('获取日志失败:', error);
                    console.log('轮询继续运行，不会因为单次错误而停止');
                    // 即使出错也继续轮询，不停止
                }
            }, 500); // 改为0.5秒刷新一次
            
            console.log('轮询已启动，ID:', logInterval);
        }

        // 停止导入
        function stopImport() {
            if (logInterval) {
                clearInterval(logInterval);
                logInterval = null;
            }
            updateStatus('导入已停止', 'info');
        }

        // 自动刷新开关
        function toggleAutoRefresh() {
            autoRefreshEnabled = !autoRefreshEnabled;
            console.log('切换自动刷新状态:', autoRefreshEnabled);
            
            const btn = document.getElementById('autoRefreshBtn');
            
            if (autoRefreshEnabled) {
                btn.innerHTML = '<i class="fas fa-pause"></i> 自动刷新: 开启';
                btn.className = 'btn btn-success';
                console.log('开启自动刷新，启动轮询');
                startLogPolling();
            } else {
                btn.innerHTML = '<i class="fas fa-play"></i> 自动刷新: 关闭';
                btn.className = 'btn btn-warning';
                console.log('关闭自动刷新，停止轮询');
                if (logInterval) {
                    clearInterval(logInterval);
                    logInterval = null;
                }
            }
        }

        // 刷新日志
        async function refreshLog() {
            try {
                const response = await axios.get('/get_log');
                document.getElementById('logArea').textContent = response.data.log;
            } catch (error) {
                updateStatus('刷新日志失败: ' + error.message, 'error');
            }
        }

        // 测试函数 - 可以在控制台调用
        window.testButton = function() {
            console.log('=== 按钮测试 ===');
            const loadFieldsBtn = document.getElementById('loadFieldsBtn');
            if (loadFieldsBtn) {
                console.log('按钮存在:', loadFieldsBtn);
                console.log('按钮禁用状态:', loadFieldsBtn.disabled);
                console.log('按钮onclick:', loadFieldsBtn.onclick);
                
                // 手动触发点击
                console.log('手动触发点击事件...');
                loadFieldsBtn.click();
            } else {
                console.log('按钮不存在!');
            }
        };
        
        // 测试表选择
        window.testTableSelection = function() {
            console.log('=== 表选择测试 ===');
            const sourceTable = document.getElementById('sourceTable');
            const targetTable = document.getElementById('targetTable');
            
            console.log('源表选择:', sourceTable ? sourceTable.value : '未找到');
            console.log('目标表选择:', targetTable ? targetTable.value : '未找到');
            
            if (sourceTable && targetTable) {
                // 设置测试值
                sourceTable.value = 'destoon_news';
                targetTable.value = 'dr_1_news';
                
                console.log('设置测试值后:');
                console.log('源表:', sourceTable.value);
                console.log('目标表:', targetTable.value);
                
                // 触发change事件
                onTableChange();
            }
        };

        // 页面加载完成后自动加载表
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus('系统初始化完成，正在加载数据库表...', 'info');
            
            // 测试按钮是否存在
            console.log('页面加载完成，检查按钮元素:');
            console.log('loadFieldsBtn:', document.getElementById('loadFieldsBtn'));
            console.log('previewBtn:', document.getElementById('previewBtn'));
            console.log('startImportBtn:', document.getElementById('startImportBtn'));
            
            // 测试onclick事件
            const loadFieldsBtn = document.getElementById('loadFieldsBtn');
            if (loadFieldsBtn) {
                console.log('loadFieldsBtn onclick:', loadFieldsBtn.onclick);
                console.log('loadFieldsBtn disabled:', loadFieldsBtn.disabled);
            }
            
            // 延迟加载表列表
            setTimeout(() => {
                loadSourceTables();
            }, 500);
            
            setTimeout(() => {
                loadTargetTables();
            }, 1000);
        });
        
        // 检查轮询状态
        function checkPollingStatus() {
            console.log('=== 轮询状态检查 ===');
            console.log('autoRefreshEnabled:', autoRefreshEnabled);
            console.log('logInterval:', logInterval);
            console.log('logInterval 类型:', typeof logInterval);
            if (logInterval) {
                console.log('轮询正在运行');
            } else {
                console.log('轮询已停止');
            }
        }
        
        // 手动重启轮询
        function restartPolling() {
            console.log('手动重启轮询');
            if (logInterval) {
                clearInterval(logInterval);
                logInterval = null;
            }
            startLogPolling();
        }
        
        // 将函数暴露到全局作用域，方便调试
        window.checkPollingStatus = checkPollingStatus;
        window.restartPolling = restartPolling;
        
    </script>
</body>
</html>
